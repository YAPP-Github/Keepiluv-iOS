name: CD (main â†’ App Store Connect)

on:
  push:
    branches: [main]

jobs:
  deploy_main:
    runs-on: macos-15
    steps:
      - name: ðŸ”„ Checkout source code
        uses: actions/checkout@v4

      - name: ðŸ›  Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          keychain-name: ${{ secrets.KEYCHAIN_NAME }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          install-swiftlint: "false"
          include-pulse: "false"

      - name: ðŸš€ Deploy to App Store Connect (Twix)
        env:
          MATCH_REPO_URL: ${{ secrets.MATCH_REPO_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}

          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          DEV_TEAM_ID: ${{ secrets.DEV_TEAM_ID }}
          DIST_TEAM_ID: ${{ secrets.DIST_TEAM_ID }}

          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_P8_BASE64: ${{ secrets.ASC_KEY_P8_BASE64 }}
        run: bundle exec fastlane deploy_main

      - name: ðŸ§¹ Teardown()
        if: always()
        env:
          KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}
        run: |
          if [ -n "${KEYCHAIN_NAME:-}" ]; then
            security delete-keychain "$HOME/Library/Keychains/$KEYCHAIN_NAME" || true
          fi
