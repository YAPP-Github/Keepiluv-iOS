name: CD (develop ‚Üí TestFlight)

on:
  pull_request:  # ÌÖåÏä§Ìä∏Ïö© (ÌÖåÏä§Ìä∏ ÌõÑ push developÏúºÎ°ú ÏõêÎ≥µ)

jobs:
  deploy_develop:
    runs-on: macos-15
    steps:
      - name: üîÑ Checkout source code
        uses: actions/checkout@v4

      - name: üõ† Setup Build Environment
        uses: ./.github/actions/setup-build-env
        with:
          keychain-name: ${{ secrets.KEYCHAIN_NAME }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          install-swiftlint: "false"

      - name: üöÄ Deploy to TestFlight (TwixDebug)
        env:
          MATCH_REPO_URL: ${{ secrets.MATCH_REPO_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}

          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          DEV_TEAM_ID: ${{ secrets.DEV_TEAM_ID }}
          DIST_TEAM_ID: ${{ secrets.DIST_TEAM_ID }}

          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_P8_BASE64: ${{ secrets.ASC_KEY_P8_BASE64 }}
        run: bundle exec fastlane deploy_develop

      - name: üßπ Teardown()
        if: always()
        env:
          KEYCHAIN_NAME: ${{ secrets.KEYCHAIN_NAME }}
        run: |
          if [ -n "${KEYCHAIN_NAME:-}" ]; then
            security delete-keychain "$HOME/Library/Keychains/$KEYCHAIN_NAME" || true
          fi
